/*********************************************************************************************************************
 * @file        car_config.h
 * @brief       飞檐走壁智能车 - 全局配置与引脚定义
 * @details     定义所有硬件引脚映射、系统参数、调试开关
 * @author      智能车竞赛代码
 * @version     1.0
 * @date        2026-02-01
 * 
 * @note        第21届全国大学生智能车竞赛 - 飞檐走壁组
 *              主控芯片: STC32G12K128
 *              基于逐飞科技开源库开发
 ********************************************************************************************************************/

#ifndef __CAR_CONFIG_H__
#define __CAR_CONFIG_H__

#include "zf_common_headfile.h"

/*==================================================================================================================
 *                                              系统参数配置
 *==================================================================================================================*/

// 系统时钟频率 (Hz)
#define SYSTEM_CLOCK_FREQ       30000000UL      // 30MHz 系统时钟

// 控制周期 (ms) - 主循环定时中断周期
#define CONTROL_PERIOD_MS       5               // 5ms 控制周期 (200Hz)

// 调试开关 (1=开启, 0=关闭) - 可通过拨码开关动态控制
#define DEBUG_ENABLE            1               // 总调试开关 (编译时开启, 运行时由拨码开关控制)
#define DEBUG_UART_ENABLE       1               // 串口调试输出
#define DEBUG_OLED_ENABLE       1               // OLED显示调试

/*==================================================================================================================
 *                                              运行模式定义
 *==================================================================================================================*/
// 运行模式枚举 (由拨码开关 P7.5 控制)
typedef enum {
    MODE_DEBUG = 0,             // 调车模式: 低速、详细调试信息、安全限制
    MODE_RACE  = 1              // 比赛模式: 高速、最小化输出、全性能
} car_mode_e;

// 调试功能枚举 - 暂时保留但简化
typedef enum {
    DEBUG_FUNC_NORMAL = 0,      // 正常运行
    DEBUG_FUNC_TEST   = 1       // 测试模式
} debug_func_e;

/*==================================================================================================================
 *                                              按键与拨码开关引脚定义
 *==================================================================================================================*/

/*--------------------------------------------------
 * 按键检测 (按下P7.0读到低电平0, 表达式成立返回1)
 *--------------------------------------------------*/
#define KEY_START_PRESSED()     (gpio_get_level(IO_P70) == 0)   /* P7.0启动按键按下=1 */

/*--------------------------------------------------
 * 运行模式检测 (P7.5拨码开关)
 * - 拨到ON位置: 接地, 读到低电平0, 表达式成立返回1 → 比赛模式
 * - 拨到OFF位置: 悬空上拉, 读到高电平1, 表达式不成立返回0 → 调车模式
 *--------------------------------------------------*/
#define IS_RACE_MODE()          (gpio_get_level(IO_P75) == 0)   /* P7.5=ON → 比赛模式=1 */
#define IS_DEBUG_MODE()         (gpio_get_level(IO_P75) == 1)   /* P7.5=OFF → 调车模式=1 */

/*==================================================================================================================
 *                                              电机驱动引脚定义
 *==================================================================================================================*/
// 使用逐飞 8701 电机驱动
// PWM频率建议: 15-20kHz

// 左电机
#define MOTOR_LEFT_DIR_PIN      IO_P60          // 左电机方向引脚
#define MOTOR_LEFT_PWM_CH       PWMA_CH2P_P62   // 左电机PWM通道 (P6.2)

// 右电机
#define MOTOR_RIGHT_DIR_PIN     IO_P64          // 右电机方向引脚
#define MOTOR_RIGHT_PWM_CH      PWMA_CH4P_P66   // 右电机PWM通道 (P6.6)

// PWM参数
#define MOTOR_PWM_FREQ          17000           // 电机PWM频率 (Hz), 17kHz
#define MOTOR_PWM_DUTY_MAX      10000           // PWM占空比最大值 (对应100%)
#define MOTOR_SPEED_MAX         8000            // 电机速度限幅值

/*==================================================================================================================
 *                                              编码器引脚定义
 *==================================================================================================================*/
// 龙邱6线编码器 - 脉冲+方向模式 (非正交解码)

// 左编码器
#define ENCODER_LEFT_A_CH       TIM3_ENCOEDER_P04   // 左编码器A相(脉冲) P0.4
#define ENCODER_LEFT_DIR_PIN    IO_P53              // 左编码器方向引脚 P5.3
#define ENCODER_LEFT_INDEX      TIM3_ENCOEDER       // 左编码器定时器索引

// 右编码器
#define ENCODER_RIGHT_A_CH      TIM0_ENCOEDER_P34   // 右编码器A相(脉冲) P3.4
#define ENCODER_RIGHT_DIR_PIN   IO_P35              // 右编码器方向引脚 P3.5
#define ENCODER_RIGHT_INDEX     TIM0_ENCOEDER       // 右编码器定时器索引

// 编码器方向取反 (根据实际安装调整, 1=取反, 0=不取反)
#define ENCODER_LEFT_REVERSE    0
#define ENCODER_RIGHT_REVERSE   1                   // 左右电机对称安装，通常需要取反

/*==================================================================================================================
 *                                              电磁循迹引脚定义
 *==================================================================================================================*/
// 4路电感 - 运放模块: 逐飞 OPM4A (V3.3)
// 采样无需高速, 硬件已完成检波滤波, 输出DC电压
// 电感参数: 10.5mH + 6.2nF, 谐振频率 ~20kHz

// 左侧电感组 (横向 + 纵向, 用于向量计算)
#define INDUCTOR_LEFT_X_CH      ADC_CH8_P00     // 左横向电感 P0.0
#define INDUCTOR_LEFT_Y_CH      ADC_CH13_P01    // 左纵向电感 P0.1

// 右侧电感组 (横向 + 纵向)
#define INDUCTOR_RIGHT_X_CH     ADC_CH9_P06     // 右横向电感 P0.6
#define INDUCTOR_RIGHT_Y_CH     ADC_CH14_P05    // 右纵向电感 P0.5

// ADC采样参数
#define INDUCTOR_ADC_RESOLUTION ADC_12BIT       // ADC分辨率
#define INDUCTOR_FILTER_COUNT   5               // 滑动平均滤波次数 (硬件已滤波, 软件轻量处理)

// 电感归一化校准参数 (根据实际硬件放大倍数调整)
// 公式: normalized = (raw - MIN) * 100 / (MAX - MIN)
#define INDUCTOR_LX_MIN         200             // 左横向电感最小值
#define INDUCTOR_LX_MAX         3800            // 左横向电感最大值 (12bit ADC)
#define INDUCTOR_LY_MIN         200             // 左纵向电感最小值
#define INDUCTOR_LY_MAX         3800            // 左纵向电感最大值
#define INDUCTOR_RX_MIN         200             // 右横向电感最小值
#define INDUCTOR_RX_MAX         3800            // 右横向电感最大值
#define INDUCTOR_RY_MIN         200             // 右纵向电感最小值
#define INDUCTOR_RY_MAX         3800            // 右纵向电感最大值

/*==================================================================================================================
 *                                              电池电压监测引脚定义
 *==================================================================================================================*/
// 电阻分压采样: 上拉200k, 下拉20k, 分压比 = 20 / (200 + 20) = 1/11

#define BATTERY_ADC_CH          ADC_CH5_P15     // 电池电压采样引脚 P1.5
#define BATTERY_DIVIDER_RATIO   11.0f           // 分压系数 (实际电压 = ADC电压 × 11)
#define BATTERY_ADC_REF_MV      3300            // ADC参考电压 (mV)
#define BATTERY_LOW_THRESHOLD   11.0f           // 低压保护阈值 (V)
#define BATTERY_CRITICAL_THRES  10.5f           // 严重低压阈值 (V), 立即停机

/*==================================================================================================================
 *                                              蜂鸣器引脚定义
 *==================================================================================================================*/

#define BUZZER_PIN              IO_P67          // 蜂鸣器引脚 P6.7
#define BUZZER_ACTIVE_HIGH      1               // 1=高电平响, 0=低电平响

// 蜂鸣器控制宏
#if BUZZER_ACTIVE_HIGH
    #define BUZZER_ON()         gpio_high(BUZZER_PIN)
    #define BUZZER_OFF()        gpio_low(BUZZER_PIN)
#else
    #define BUZZER_ON()         gpio_low(BUZZER_PIN)
    #define BUZZER_OFF()        gpio_high(BUZZER_PIN)
#endif
#define BUZZER_TOGGLE()         gpio_toggle_level(BUZZER_PIN)

/*==================================================================================================================
 *                                              蓝牙通信引脚定义
 *==================================================================================================================*/
// 蓝牙模块: JDY-23, 使用 UART4

#define BLUETOOTH_UART_INDEX    UART_4          // UART4
#define BLUETOOTH_TX_PIN        UART4_TX_P03    // TX = P0.3
#define BLUETOOTH_RX_PIN        UART4_RX_P02    // RX = P0.2
#define BLUETOOTH_BAUD_RATE     9600            // 波特率 9600bps
#define BLUETOOTH_RX_BUF_SIZE   64              // 接收缓冲区大小

/*==================================================================================================================
 *                                              调试串口引脚定义
 *==================================================================================================================*/
// 调试/下载串口: UART2
// 注意: DEBUG_UART_INDEX 已在库中定义 (zf_common_debug.h), 这里使用不同名称

#define CAR_DEBUG_UART_INDEX    UART_2          // UART2
#define CAR_DEBUG_TX_PIN        UART2_TX_P11    // TX = P1.1
#define CAR_DEBUG_RX_PIN        UART2_RX_P10    // RX = P1.0
#define CAR_DEBUG_BAUD_RATE     115200          // 波特率 115200bps

/*==================================================================================================================
 *                                              负压风扇引脚定义
 *==================================================================================================================*/
// 吸附负压风扇 PWM 控制

#define FAN_PWM_CH              PWMB_CH3_P33    // 风扇PWM通道 P3.3
#define FAN_PWM_FREQ            25000           // 风扇PWM频率 (Hz), 25kHz 高频
#define FAN_DUTY_MIN            0               // 最小占空比 (0%)
#define FAN_DUTY_MAX            10000           // 最大占空比 (100%)
#define FAN_DUTY_DEFAULT        2000            // 默认占空比 (20%)
#define FAN_DUTY_WALL           7000            // 上墙时占空比 (70%)

// 风扇自适应控制参数 (基于IMU俯仰角)
#define FAN_ANGLE_THRESHOLD     15              // 开始增大吸力的俯仰角阈值 (度)
#define FAN_ANGLE_MAX           60              // 最大倾斜角 (度)

/*==================================================================================================================
 *                                              IMU660RA 引脚定义
 *==================================================================================================================*/
// 六轴惯性测量单元 IMU660RA - SPI 接口
// 注意: 这些引脚需要在 zf_device_imu660ra.h 中修改对应宏定义

#define IMU_SPI_SCK_PIN         IO_P40          // SPI时钟 P4.0
#define IMU_SPI_MOSI_PIN        IO_P41          // SPI主出从入 P4.1
#define IMU_SPI_MISO_PIN        IO_P42          // SPI主入从出 P4.2
#define IMU_SPI_CS_PIN          IO_P43          // SPI片选 P4.3

/*==================================================================================================================
 *                                              OLED 引脚定义
 *==================================================================================================================*/
// OLED 显示屏 - I2C 接口

#define OLED_I2C_SCL_PIN        IO_P25          // I2C时钟 P2.5
#define OLED_I2C_SDA_PIN        IO_P24          // I2C数据 P2.4

/*==================================================================================================================
 *                                              PID 参数默认值
 *==================================================================================================================*/

// 速度环 PID (增量式)
#define PID_SPEED_KP            2.0f
#define PID_SPEED_KI            0.5f
#define PID_SPEED_KD            0.0f
#define PID_SPEED_OUT_MAX       MOTOR_PWM_DUTY_MAX

// 方向环 PID (位置式)
#define PID_DIRECTION_KP        5.0f
#define PID_DIRECTION_KI        0.0f
#define PID_DIRECTION_KD        3.0f
#define PID_DIRECTION_OUT_MAX   3000

// 姿态环 PID (用于上墙平衡)
#define PID_ATTITUDE_KP         1.0f
#define PID_ATTITUDE_KI         0.0f
#define PID_ATTITUDE_KD         0.5f
#define PID_ATTITUDE_OUT_MAX    2000

/*==================================================================================================================
 *                                              通用工具宏
 *==================================================================================================================*/

// 限幅宏 - 将 x 限制在 [a, b] 范围内
#define LIMIT_RANGE(x, a, b)    ((x) < (a) ? (a) : ((x) > (b) ? (b) : (x)))

// 绝对值宏
#define ABS_VALUE(x)            ((x) >= 0 ? (x) : -(x))

// 符号函数宏
#define SIGN_VALUE(x)           ((x) > 0 ? 1 : ((x) < 0 ? -1 : 0))

// 快速平方根 (使用整数近似, 适用于电感向量计算, 提高运算速度)
// 输入范围: 0 ~ 20000, 精度约 5%
uint16 fast_sqrt(uint32 val);

#endif // __CAR_CONFIG_H__
