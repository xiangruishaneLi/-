/*********************************************************************************************************************
 * @file        fan.c
 * @brief       飞檐走壁智能车 - 负压风扇控制模块 (源文件)
 * @details     实现 PWM 控制吸附风扇
 * @author      智能车竞赛代码
 * @version     1.0
 * @date        2026-02-01
 ********************************************************************************************************************/

#include "fan.h"

/*==================================================================================================================
 *                                              私有变量
 *==================================================================================================================*/

static uint16 s_fan_duty = 0;               // 当前占空比
static FanMode_t s_fan_mode = FAN_MODE_OFF; // 当前模式

/*==================================================================================================================
 *                                              风扇初始化
 *==================================================================================================================*/

/**
 * @brief   初始化风扇模块
 */
void Fan_Init(void)
{
    // 初始化 PWM (高频, 减少噪音)
    pwm_init(FAN_PWM_CH, FAN_PWM_FREQ, 0);
    
    // 默认关闭
    s_fan_duty = 0;
    s_fan_mode = FAN_MODE_OFF;
}

/*==================================================================================================================
 *                                              设置占空比
 *==================================================================================================================*/

/**
 * @brief   设置风扇占空比
 */
void Fan_SetDuty(uint16 duty)
{
    // 限幅
    if (duty > FAN_DUTY_MAX)
    {
        duty = FAN_DUTY_MAX;
    }
    
    s_fan_duty = duty;
    pwm_set_duty(FAN_PWM_CH, duty);
}

/*==================================================================================================================
 *                                              设置模式
 *==================================================================================================================*/

/**
 * @brief   设置风扇模式
 */
void Fan_SetMode(FanMode_t mode)
{
    s_fan_mode = mode;
    
    switch (mode)
    {
        case FAN_MODE_OFF:
            Fan_SetDuty(0);
            break;
            
        case FAN_MODE_GROUND:
            Fan_SetDuty(FAN_DUTY_DEFAULT);
            break;
            
        case FAN_MODE_WALL:
            Fan_SetDuty(FAN_DUTY_WALL);
            break;
            
        case FAN_MODE_AUTO:
            // 自动模式由 Fan_AutoAdjust 控制
            break;
            
        default:
            break;
    }
}

/*==================================================================================================================
 *                                              获取占空比
 *==================================================================================================================*/

/**
 * @brief   获取当前风扇占空比
 */
uint16 Fan_GetDuty(void)
{
    return s_fan_duty;
}

/*==================================================================================================================
 *                                              自适应控制
 *==================================================================================================================*/

/**
 * @brief   风扇自适应控制 (根据IMU俯仰角)
 * @note    算法:
 *          - |pitch| < 阈值: 地面模式占空比
 *          - |pitch| >= 阈值: 线性插值到最大占空比
 *          - |pitch| >= 最大角度: 最大占空比
 * 
 *          公式:
 *          duty = DEFAULT + (WALL - DEFAULT) * (|pitch| - THRESHOLD) / (MAX_ANGLE - THRESHOLD)
 */
void Fan_AutoAdjust(int16 pitch_angle)
{
    int16 abs_pitch;
    uint16 duty;
    int32 temp;
    
    // 仅在自动模式下生效
    if (s_fan_mode != FAN_MODE_AUTO)
    {
        return;
    }
    
    // 取绝对值
    abs_pitch = (pitch_angle >= 0) ? pitch_angle : -pitch_angle;
    
    // 判断是否需要增大吸力
    if (abs_pitch < FAN_ANGLE_THRESHOLD)
    {
        // 地面模式
        duty = FAN_DUTY_DEFAULT;
    }
    else if (abs_pitch >= FAN_ANGLE_MAX)
    {
        // 完全上墙, 最大吸力
        duty = FAN_DUTY_WALL;
    }
    else
    {
        // 线性插值
        // duty = DEFAULT + (WALL - DEFAULT) * (abs_pitch - THRESHOLD) / (MAX - THRESHOLD)
        temp = (int32)(FAN_DUTY_WALL - FAN_DUTY_DEFAULT) *
               (int32)(abs_pitch - FAN_ANGLE_THRESHOLD) /
               (int32)(FAN_ANGLE_MAX - FAN_ANGLE_THRESHOLD);
        duty = FAN_DUTY_DEFAULT + (uint16)temp;
    }
    
    // 设置占空比
    Fan_SetDuty(duty);
}

/*==================================================================================================================
 *                                              紧急停止
 *==================================================================================================================*/

/**
 * @brief   风扇紧急停止
 */
void Fan_Stop(void)
{
    s_fan_mode = FAN_MODE_OFF;
    s_fan_duty = 0;
    pwm_set_duty(FAN_PWM_CH, 0);
}
