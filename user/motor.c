/*********************************************************************************************************************
 * @file        motor.c
 * @brief       飞檐走壁智能车 - 电机驱动模块 (源文件)
 * @details     实现双电机 PWM 控制
 * @author      智能车竞赛代码
 * @version     1.0
 * @date        2026-02-01
 ********************************************************************************************************************/

#include "motor.h"
#include "key.h"          // 用于获取运行模式，实现速度自适应限制

/*==================================================================================================================
 *                                              私有变量
 *==================================================================================================================*/

// 当前电机 PWM 值 (带符号, 用于读取)
static int16 s_motor_pwm[2] = {0, 0};

/*==================================================================================================================
 *                                              电机初始化
 *==================================================================================================================*/

/**
 * @brief   初始化电机模块
 */
void Motor_Init(void)
{
    /*-------------------------------------------------
     * 初始化方向引脚 (推挽输出, 默认低电平)
     *-------------------------------------------------*/
    gpio_init(MOTOR_LEFT_DIR_PIN,  GPO, 0, GPO_PUSH_PULL);
    gpio_init(MOTOR_RIGHT_DIR_PIN, GPO, 0, GPO_PUSH_PULL);
    
    /*-------------------------------------------------
     * 初始化 PWM 引脚
     * 频率: 17kHz (MOTOR_PWM_FREQ)
     * 初始占空比: 0
     *-------------------------------------------------*/
    pwm_init(MOTOR_LEFT_PWM_CH,  MOTOR_PWM_FREQ, 0);
    pwm_init(MOTOR_RIGHT_PWM_CH, MOTOR_PWM_FREQ, 0);
    
    // 清零 PWM 记录
    s_motor_pwm[0] = 0;
    s_motor_pwm[1] = 0;
}

/*==================================================================================================================
 *                                              电机速度设置
 *==================================================================================================================*/

/**
 * @brief   设置单个电机速度
 */
void Motor_SetSingle(uint8 motor_id, int16 speed)
{
    uint32 duty;
    gpio_pin_enum dir_pin;
    pwm_channel_enum pwm_ch;
    int16 speed_limit;  // C89要求变量声明在代码块开头
    
    // 选择电机引脚
    if (motor_id == 0)  // 左电机
    {
        dir_pin = MOTOR_LEFT_DIR_PIN;
        pwm_ch  = MOTOR_LEFT_PWM_CH;
    }
    else                // 右电机
    {
        dir_pin = MOTOR_RIGHT_DIR_PIN;
        pwm_ch  = MOTOR_RIGHT_PWM_CH;
    }
    
    // 根据运行模式获取速度限幅值
    // 调车模式: DEBUG_MODE_SPEED_MAX (3000)
    // 比赛模式: MOTOR_SPEED_MAX (8000)
    speed_limit = (int16)GET_SPEED_LIMIT();
    
    // 限幅
    if (speed > speed_limit)  speed = speed_limit;
    if (speed < -speed_limit) speed = -speed_limit;
    
    // 记录 PWM 值
    s_motor_pwm[motor_id] = speed;
    
    // 根据速度正负设置方向
    if (speed >= 0)
    {
        gpio_low(dir_pin);      // 正转: DIR = 0
        duty = (uint32)speed;
    }
    else
    {
        gpio_high(dir_pin);     // 反转: DIR = 1
        duty = (uint32)(-speed);
    }
    
    // 设置 PWM 占空比
    pwm_set_duty(pwm_ch, duty);
}

/**
 * @brief   设置左右电机速度
 */
void Motor_SetSpeed(int16 left_speed, int16 right_speed)
{
    Motor_SetSingle(0, left_speed);     // 左电机
    Motor_SetSingle(1, right_speed);    // 右电机
}

/*==================================================================================================================
 *                                              电机停止与刹车
 *==================================================================================================================*/

/**
 * @brief   电机紧急停止
 */
void Motor_Stop(void)
{
    // PWM 设为 0
    pwm_set_duty(MOTOR_LEFT_PWM_CH, 0);
    pwm_set_duty(MOTOR_RIGHT_PWM_CH, 0);
    
    // 清零记录
    s_motor_pwm[0] = 0;
    s_motor_pwm[1] = 0;
}

/**
 * @brief   电机刹车
 */
void Motor_Brake(void)
{
    // 设置 PWM 为 0, 方向引脚保持, 利用电机反电动势制动
    // 也可以将 PWM 设为最大配合方向引脚短接来刹车
    // 这里采用简单方式: 直接停止
    Motor_Stop();
}

/*==================================================================================================================
 *                                              获取当前 PWM 值
 *==================================================================================================================*/

/**
 * @brief   获取当前电机 PWM 输出值
 */
int16 Motor_GetPWM(uint8 motor_id)
{
    if (motor_id < 2)
    {
        return s_motor_pwm[motor_id];
    }
    return 0;
}
