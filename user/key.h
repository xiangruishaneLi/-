/*********************************************************************************************************************
 * @file        key.h
 * @brief       按键与拨码开关模块 - 简化版
 * @details     只实现最核心功能: 模式切换 + 启动延迟
 * @author      智能车竞赛代码
 * @version     2.0
 * @date        2026-02-02
 * 
 * @note        硬件连接:
 *              - P7.0: 启动按键 (按下后3秒启动)
 *              - P7.5: 拨码开关 (OFF=调车模式, ON=比赛模式)
 * 
 *              使用说明:
 *              1. 上电后检查拨码开关位置选择模式
 *              2. 按下启动按键,蜂鸣器响3声后小车开始运行
 *              3. 调车模式下速度限制为3000,比赛模式为8000
 ********************************************************************************************************************/

#ifndef __KEY_H__
#define __KEY_H__

#include "zf_common_headfile.h"
#include "car_config.h"

/*==================================================================================================================
 *                                              运行状态定义
 *==================================================================================================================*/

// 小车运行状态
typedef enum {
    CAR_STATE_IDLE = 0,         // 空闲状态 (等待启动)
    CAR_STATE_COUNTDOWN,        // 倒计时中 (3秒)
    CAR_STATE_RUNNING,          // 运行中
    CAR_STATE_STOPPED           // 已停止
} car_state_e;

/*==================================================================================================================
 *                                              函数声明
 *==================================================================================================================*/

/**
 * @brief   按键模块初始化
 * @note    初始化启动按键(P7.0)和拨码开关(P7.5)
 */
void key_init(void);

/**
 * @brief   按键周期扫描 (需在定时中断或主循环中调用)
 * @note    建议调用周期: 10ms
 *          此函数会自动处理:
 *          - 启动按键检测和3秒倒计时
 *          - 拨码开关状态读取
 */
void key_scan(void);

/**
 * @brief   获取是否为比赛模式
 * @return  1=比赛模式(高速), 0=调车模式(低速安全)
 */
uint8 key_is_race_mode(void);

/**
 * @brief   获取小车当前运行状态
 * @return  CAR_STATE_IDLE / CAR_STATE_COUNTDOWN / CAR_STATE_RUNNING / CAR_STATE_STOPPED
 */
car_state_e key_get_car_state(void);

/**
 * @brief   检查小车是否应该运行
 * @return  1=应该运行(已完成3秒倒计时), 0=不应运行
 */
uint8 key_car_should_run(void);

/**
 * @brief   停止小车 (可用于紧急停止)
 */
void key_stop_car(void);

/**
 * @brief   重置到空闲状态 (可重新按键启动)
 */
void key_reset_to_idle(void);

/*==================================================================================================================
 *                                              速度限制宏
 *==================================================================================================================*/

// 调车模式下的速度限制 (安全考虑)
#define DEBUG_MODE_SPEED_MAX    3000            // 调车模式最大速度 (37.5%)
#define RACE_MODE_SPEED_MAX     MOTOR_SPEED_MAX // 比赛模式使用全速 (8000)

// 获取当前模式下的速度限制
#define GET_SPEED_LIMIT()       (key_is_race_mode() ? RACE_MODE_SPEED_MAX : DEBUG_MODE_SPEED_MAX)

/*==================================================================================================================
 *                                              启动延迟参数
 *==================================================================================================================*/

#define START_COUNTDOWN_MS      3000            // 启动倒计时 3秒
#define KEY_DEBOUNCE_TIME_MS    30              // 按键消抖时间 30ms

#endif // __KEY_H__
